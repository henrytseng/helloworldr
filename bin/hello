#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

NODE=""
NVM_DIR="${NVM_DIR:=$HOME/.nvm}"
NODE_VERSION="5.9.1"
HELLO_HOME="${HELLO_HOME:-$HOME/.helloworldr}"

function node() {
  $NODE --eval "$1"
}

# Bootstap environment
function init_env {
  mkdir -p "$HELLO_HOME/versions"
  pushd "$HELLO_HOME/versions"
  if [ -s "$HELLO_HOME" ]
  then
    echo 'Existing initialized helloworldr'
  else
    echo 'Initializing helloworldr'
    rm -rf ./latest
    git clone --depth 1 https://github.com/henrytseng/helloworldr.git latest
  fi
  ls ./latest/bin
  ./latest/bin/version
  popd
}

# Install nvm if not already installed
function use_nvm {
  if [ -s "$NVM_DIR/nvm.sh" ]
  then
    echo 'Existing nvm version'
  else
    echo 'Installing nvm'
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh 2>/dev/null | bash
  fi
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
  nvm install $NODE_VERSION
  NODE=$(which node)
}

# Execute
use_nvm
init_env
