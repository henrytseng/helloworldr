#!/usr/local/bin/node

var fs = require('fs');
var path = require('path');
var exec = require('child_process').exec;

var script = process.argv[1].split('/').pop();

if(process.argv.length < 4) {
  console.log('Usage: '+script+' {ext} {cmd}');
  process.exit(1);

} else if(process.argv.indexOf('-h') !== -1) {
  console.log('Usage: '+script+' {ext} {cmd}');
  console.log(' {ext}  A file extension');
  console.log(' {exec} A command to execute for each new file change');
  process.exit();
}

var cmd = process.argv.pop();
var ext = process.argv.pop();

function run(file) {
  console.log('\x1b[34mRunning:', cmd+file, '\x1b[0m');

  var child = exec(cmd+' '+file);
  child.stdout.on('data', function(data) {
    process.stdout.write(data);
  });
  child.stderr.on('data', function(data) {
    process.stderr.write(data);
  });

  // Complete
  child.on('close', function() {

  });
}

console.log('\x1b[34mWatching:\x1b[0m');
fs.watch(process.cwd(), function(event, filename) {
  if(filename.match(new RegExp('.'+ext+'$'))) {
    run(filename);
  }
});
