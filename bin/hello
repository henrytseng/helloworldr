#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

NODE=""
NPM=""
NVM_DIR="${NVM_DIR:=$HOME/.nvm}"
NODE_VERSION="5.9.1"
HELLO_HOME="${HELLO_HOME:-$HOME/.helloworldr}"
LATEST_VERSION=""
GIT_REPO="https://github.com/henrytseng/helloworldr.git"

# Bootstap environment
function init_env {
  if [ -s "$HELLO_HOME" ]
  then
    echo 'Existing initialized helloworldr'
  else
    echo 'Initializing helloworldr'
    mkdir -p "$HELLO_HOME/versions"
    pushd "$HELLO_HOME/versions"
    rm -rf latest
    git clone --depth 1 $GIT_REPO latest
    cd latest
    LATEST_VERSION="$($NODE lib/cli/get-version)"
    cd ..
    mv latest $LATEST_VERSION
    popd
  fi
  popd
}

# Install nvm if not already installed
function use_nvm {
  if [ -s "$NVM_DIR/nvm.sh" ]
  then
    echo 'Existing nvm version'
    NODE="$NVM_DIR/versions/node/v$NODE_VERSION/bin/node"
    NPM="$NVM_DIR/versions/node/v$NODE_VERSION/bin/npm"
  else
    echo 'Installing nvm'
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh 2>/dev/null | bash
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install $NODE_VERSION
    NODE=$(which node)
    NPM=$(which npm)
  fi
}

# Execute
use_nvm
init_env
