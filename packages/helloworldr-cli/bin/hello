#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

NODE=""
NPM=""
NVM_DIR="${NVM_DIR:=$HOME/.nvm}"
HELLO_HOME="${HELLO_HOME:-$HOME/.helloworldr}"
NODE_VERSION="6.0.0"
LATEST_VERSION=""
GIT_REPO="https://github.com/henrytseng/helloworldr.git"

# Bootstap environment
function bootstrap_hello {
  if [ ! -s "$HELLO_HOME" ]
  then
    mkdir -p "$HELLO_HOME/versions"
    pushd "$HELLO_HOME/versions"
    rm -rf latest
    git clone --depth 1 $GIT_REPO latest
    cd latest
    $NPM install
    LATEST_VERSION="$($NODE lib/actions/get-version)"
    cd ..
    mv latest $LATEST_VERSION
    ln -s "$HELLO_HOME/versions/$LATEST_VERSION" "$HELLO_HOME/versions/latest"
    popd
  fi
}

# Install nvm if not already installed
function use_nvm {
  if [ ! -s "$NVM_DIR/nvm.sh" ]
  then
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh 2>/dev/null | bash
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install $NODE_VERSION
  fi
  NODE=$(which node)
  NPM=$(which npm)
}

# Execute
use_nvm
bootstrap_hello
exec $NODE "$HELLO_HOME/versions/latest/lib/hello" "$@"
